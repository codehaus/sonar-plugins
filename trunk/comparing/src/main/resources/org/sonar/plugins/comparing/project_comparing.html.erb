<% def create_overview_widget(project, loader, metrics_tab, title, qualitative)
     widget =  '<div class="block"><div class="widget-title" id="widget_title">'
     widget += title
     widget += '</div>'
     widget += '<div class="widget1" style="height:100%;"><div class="widget">'
     widget += '<br /><table align="center" cellspacing="5px" cellpadding="5px" class="data">'
     widget += '<thead><tr><th align="center" class="right" width="175px">&nbsp;</th>'
     widget += '<th align="center" class="center" width="150px"><h4 style="font-size: 12px;">Project value</h4></th>'
     widget += '<th align="center" class="center" width="150px"><h4 style="font-size: 12px;">'
     if params[:projectId] != nil && params[:projectId] != ''
       widget += loader.get_project_name_by_id(params[:projectId])
       widget += ' value'
     else
       widget += 'Average value'
     end
     widget += '</h4></th></thead><tbody>'
     position = 0
     for metric in metrics_tab
       cell = create_gridline(project, loader, metric, position)
       if cell != nil
         widget += cell
         position += 1
       end
     end
     widget += '</tbody></table></div></div></div>'

     widget
   end

   def create_gridline(project, loader, metric_key, position)
     # Load the metric matches with the metric_key
     metric = metric(metric_key)
     measure = measure(metric_key)

     measure_tab = nil
     if params[:projectId] != nil && params[:projectId] != ''
       measure_tab = loader.get_measure_value_for_other_project(metric_key, params[:projectId])
     else
       # Load the aggregate nbloc value for the language use by the current project
       measure_tab = loader.get_avg_measure_for_language(metric_key, project.language)
     end

     cell = nil
     if measure_tab != nil
       if measure != nil
         if (position % 2) == 1
           cell =  '<tr class="odd">'
         else
           cell =  '<tr class="even">'
         end
         cell += '  <td align="left"><h4 style="font-size: 12px;">'
         cell += metric.short_name
         cell += '  </h4></td>'
         cell += '  <td align="right">'
     
         measure_average = nil
         if metric.val_type == 'INT'
           measure_average = measure_tab.to_f.round
         else
           measure_average = measure_tab.to_f.round(1)
         end
         cell += create_project_cell(metric, measure_average)
         cell += '  </td>'
         cell += '  <td align="right">'
         cell += '    <table align="center" width="65px"><tr><td align="right" width="100%"><b>'
         cell += number_with_delimiter(measure_average)
         cell += '    </b></td></tr></table>'
         cell += '  </td></tr>'

       end
     end

     cell     
   end

   def create_project_cell(metric, valueCompare) 
     cell =  '<table align="center" width="150px">'
     color = get_color(metric, valueCompare)
     cell += '  <tr><td style="color: '
     cell += color
     cell += ';" align="right" width="50%"><b>'
     measure = nil
     variation = nil
     if metric.val_type == 'INT'
       measure = measure(metric).value.to_i
       variation = measure - valueCompare
     else
       measure = measure(metric).value.to_f
       variation = (measure - valueCompare).round(1)
     end
     cell += number_with_delimiter(measure)
     cell += '  </b>&nbsp;</td>'
     variation_str = nil
     if variation < 0
       variation_str = number_with_delimiter(variation)
     else
       variation_str =  '+'
       variation_str += number_with_delimiter(variation)
     end
     cell += '<td style="color: '
     cell += color
     cell += ';" align="left" width="50%"><b>(' + variation_str + ')</b></td></tr>'
     cell += '</table>'

     cell
   end

   def get_color(metric, valueCompare)
      color = 'gray'
      measure_tmp = measure(metric)
      if measure_tmp != nil
        if metric.qualitative == true
          if measure(metric).value == valueCompare
             color = 'green'
          else 
             if measure(metric).value > valueCompare
                if metric.direction < 0
                   color = 'red'
                else
                   color = 'green'
                end
             else
                if metric.direction < 0
                   color = 'green'
                else
                   color = 'red'
                end
             end
          end
       end
     end

     color
   end %>

<div id="dashboard">
  <div style="width: 100%;display: block; float: none">

<% loader = ComparingLoader.new %>

    <!-- the right margin with 1px is a trick for IE. See SONAR-2637 -->
    <div class="dashboard-column-wrapper" style="width: 50%;margin: 0 -1px 0 0;">
      <div class="dashboard-column" id="dashboard-column-1" style="margin: 0 5px 0 0px;">
        <div class="block"><div class="widget-title" id="widget_title"><%= message('comparing.informations.title') -%></div>
        <div class="widget1" style="height:100%;"><div class="widget">
          <div class="notice" id="info">
             <span id="infomsg"><%= message('comparing.average.projects', :params => [loader.get_nb_projects_for_language(@project.language)]) -%></span>
          </div>
          <form method="GET" action="<%= url_for :id => @resource.id -%>" style="display: inline" class="spacer-left">
          <input type="hidden" name="page" value="project_comparing"/>
          <table align="center" cellspacing="5px" cellpadding="5px" class="data">
            <tr class="even">
              <td align="left"><%= message('comparing.choose.project') -%></td>
              <td align="left">
<%            projects = loader.get_projects_for_language(@project.language) %>
                <select id="project-id" name="projectId" onchange="submit()" class="small">
                  <option value="">Average</option>
<%            for project in projects %>
                  <option value="<%= project.id -%>"
<%              if project.id.to_s == params[:projectId] %>
                     selected
<%              end %>><%= project.name -%></option>
<%            end %>
                </select>
              </td>
            </tr>
            <tr class="odd">
              <td align="left"><%= message('comparing.show.quantitative') -%></td>
              <td align="left">
                <input type="checkbox" id="quantitative" name="quantitative" value="qual" onchange="submit()" 
 <%         if params[:quantitative] != nil && params[:quantitative] != '' %> checked <% end %> />
              </td>
            </tr>
          </table>
          </form>
        </div></div></div>

<% size_metric_tab = ['ncloc', 'files'] 
   violation_metric_tab = ['violations_density']
   complexity_metric_tab = ['function_complexity', 'file_complexity']
   duplication_metric_tab = ['duplicated_lines_density']
   documentation_metric_tab = ['comment_lines_density', 'public_documented_api_density']

   if params[:quantitative] != nil && params[:quantitative] != ''
     size_metric_tab.push('functions', 'statements')
     violation_metric_tab.push('violations', 'blocker_violations', 'critical_violations', 'major_violations', 'minor_violations', 'info_violations')
     complexity_metric_tab.push('complexity')
     duplication_metric_tab.push('duplicated_lines', 'duplicated_blocks', 'duplicated_files')
     documentation_metric_tab.push('comment_lines', 'public_undocumented_api')
   end %>

<%= create_overview_widget(@project, loader, size_metric_tab, message('comparing.size.title'), false) %>
<%= create_overview_widget(@project, loader, violation_metric_tab, message('comparing.violations.title'), true) %>
      </div>
    </div>

    <div class="dashboard-column-wrapper" style="width: 50%;margin: 0 -1px 0 0;">
      <div class="dashboard-column" id="dashboard-column-2" style="margin: 0 0px 0 5px;">
<%= create_overview_widget(@project, loader, complexity_metric_tab, message('comparing.complexity.title'), true) %>
<%= create_overview_widget(@project, loader, duplication_metric_tab, message('comparing.duplication.title'), true) %>
<%= create_overview_widget(@project, loader, documentation_metric_tab, message('comparing.documentation.title'), true) %>
      </div>
    </div>

  </div>
</div>